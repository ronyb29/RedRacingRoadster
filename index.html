<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Carrito rojo de carreras</title>
    <style type="text/css">
        #params {
            color: #fff;
        }

        .circle {
            border-radius: 50%;
            width: 50px;
            height: 50px;
            background-color: red;
            margin: 25px;
        }

        .movement_canvas {
            border: solid darkred 1px;
            width: 100px;
            height: 100px;
        }
    </style>

    <script type="text/javascript">
        LEFT = 37;
        UP = 38;
        RIGHT = 39;
        DOWN = 40;
        pressed_keys = {LEFT: 0, UP: 0, DOWN: 0, RIGHT: 0};

        function keydown(event) {
            if (~event.keyCode in pressed_keys)
                return;
            pressed_keys[event.keyCode] = 1;
            position_circle();
        }

        function keyup(event) {
            if (~event.keyCode in pressed_keys)
                return;
            pressed_keys[event.keyCode] = 0;
            position_circle();
        }

        info_element = null;
        params_element = null;
        circle_element = null;

        function request_cb() {
            x_axis = pressed_keys[RIGHT] ? 127 : pressed_keys[LEFT] ? -127 : 0;
            z_axis = pressed_keys[UP] ? 127 : pressed_keys[DOWN] ? -127 : 0;
            body = JSON.stringify({acceleration: z_axis, steering: x_axis})

            req = new XMLHttpRequest();
            start = new Date().getTime();

            req.open("POST", '/move', true);
            req.onreadystatechange = function () {
                if (req.status == 0){
                    return;
                }
                info_element.innerHTML =
                        "Last req: " + new Date().toISOString() + "<br>" +
                        "readyState: " + req.readyState + "<br>" +
                        "Status: " + req.status + "<br>" +
                        "Response time: " + (new Date().getTime() - start).toString() + "<br>" +
                        "Body:" + body + "<br>" +
                        "Response text:" + "<div style=\"border: solid black 5px; max-width: 500px;\">" + req.responseText + "</div>";
            };
            req.send(body);
        }

        function position_circle() {
            z_axis = pressed_keys[UP] ? 1 : pressed_keys[DOWN] ? -1 : 0;
            circle_element.style.marginTop = (25 - 25 * z_axis) + "px";

            x_axis = pressed_keys[RIGHT] ? 1 : pressed_keys[LEFT] ? -1 : 0;
            circle_element.style.marginLeft = (25 + 25 * x_axis) + "px";
            params_element.innerHTML = "X: " + x_axis + " Z: " + z_axis;
            request_cb();
        }

        window.onload = function () {
            info_element = document.getElementById("info");
            params_element = document.getElementById("params");
            circle_element = document.getElementsByClassName("circle")[0];
        };
    </script>
</head>
<body onkeydown="keydown(event)" onkeyup="keyup(event)">
<div class="movement_canvas">
    <div class="circle"></div>
</div>
<span id="params"></span>
<br/>
<span id="info"></span>
</body>
</html>
